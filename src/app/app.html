<div class="app-container" [class.light]="isLightTheme">
  <header class="app-header">
    <div class="header-top">
      <div>
        <h1>{{ title() }}</h1>
        <p class="subtitle">
          Proyecto personal <strong>no oficial</strong>, sin relaci√≥n con el MINEDU ni con Identicole.
          Uso exclusivamente <strong>educativo y exploratorio</strong>. Usa datos p√∫blicos del portal Identicole del MINEDU.
        </p>

      </div>

      <!-- üîÜüåô Toggle de tema -->
      <button type="button" class="btn ghost theme-toggle" (click)="toggleTheme()" [attr.aria-pressed]="isLightTheme"
        [attr.aria-label]="isLightTheme ? 'Cambiar a modo oscuro' : 'Cambiar a modo claro'">
        <span class="theme-icon" aria-hidden="true">
          {{ isLightTheme ? '‚òÄÔ∏è' : 'üåô' }}
        </span>
        <span class="theme-label">
          {{ isLightTheme ? 'Claro' : 'Oscuro' }}
        </span>
      </button>
    </div>
  </header>

  <!-- ======================= Filtros ======================= -->
  <section class="card filters-card" aria-label="Filtros de b√∫squeda de colegios">
  <header class="section-header">
    <div>
      <h2>Filtra tu b√∫squeda</h2>
      <p class="filters-subtitle">
        Todos los campos son <strong>obligatorios</strong>, excepto
        <strong>‚ÄúNombre del colegio‚Äù</strong> (opcional).
      </p>
    </div>

    <p class="legend-required">
      <span class="legend-pill">
        <span class="dot"></span> Completa todos los campos requeridos para buscar.
      </span>
    </p>
  </header>

  <!-- Grupo: Ubicaci√≥n -->
  <div class="filters-group">
    <p class="filters-group-title">Ubicaci√≥n del colegio</p>

    <div class="filters-grid">
      <!-- Departamento (OBLIGATORIO) -->
      <div
        class="field"
        [class.has-error]="deptoCtrl.invalid && deptoCtrl.touched"
      >
        <div class="field-label-row">
          <label for="depto">
            Departamento <span class="required">*</span>
          </label>
          <span class="field-tag">Obligatorio</span>
        </div>

        <select
          id="depto"
          name="depto"
          required
          [(ngModel)]="selectedDepto"
          #deptoCtrl="ngModel"
          (change)="onDepartamentoChange()"
        >
          <option value="" disabled [selected]="!selectedDepto">
            Selecciona departamento
          </option>
          <option *ngFor="let d of departamentos" [value]="d.value">
            {{ d.label }}
          </option>
        </select>

        <p class="field-error" *ngIf="deptoCtrl.invalid && deptoCtrl.touched">
          El departamento es obligatorio.
        </p>
      </div>

      <!-- Provincia (OBLIGATORIO) -->
      <div
        class="field"
        [class.has-error]="provCtrl.invalid && provCtrl.touched"
      >
        <div class="field-label-row">
          <label for="prov">
            Provincia <span class="required">*</span>
          </label>
          <span class="field-tag">Obligatorio</span>
        </div>

        <select
          id="prov"
          name="prov"
          required
          [(ngModel)]="selectedProv"
          #provCtrl="ngModel"
          (change)="onProvinciaChange()"
          [disabled]="!provincias.length"
        >
          <option value="" disabled [selected]="!selectedProv">
            Selecciona provincia
          </option>
          <option *ngFor="let p of provincias" [value]="p.codprov">
            {{ p.nombre }}
          </option>
        </select>

        <p class="field-error" *ngIf="provCtrl.invalid && provCtrl.touched">
          La provincia es obligatoria.
        </p>
      </div>

      <!-- Distrito (OBLIGATORIO) -->
      <div
        class="field"
        [class.has-error]="distCtrl.invalid && distCtrl.touched"
      >
        <div class="field-label-row">
          <label for="dist">
            Distrito <span class="required">*</span>
          </label>
          <span class="field-tag">Obligatorio</span>
        </div>

        <select
          id="dist"
          name="dist"
          required
          [(ngModel)]="selectedDist"
          #distCtrl="ngModel"
          [disabled]="!distritos.length"
        >
          <option value="" disabled [selected]="!selectedDist">
            Selecciona distrito
          </option>
          <option *ngFor="let d of distritos" [value]="d.coddist">
            {{ d.nombre }}
          </option>
        </select>

        <p class="field-error" *ngIf="distCtrl.invalid && distCtrl.touched">
          El distrito es obligatorio.
        </p>
      </div>
    </div>
  </div>

  <!-- Grupo: Modalidad / Nivel -->
  <div class="filters-group">
    <p class="filters-group-title">Caracter√≠sticas del colegio</p>

    <div class="filters-grid">
      <!-- Modalidad (OBLIGATORIO) -->
      <div
        class="field"
        [class.has-error]="modalidadCtrl.invalid && modalidadCtrl.touched"
      >
        <div class="field-label-row">
          <label for="modalidad">
            Modalidad <span class="required">*</span>
          </label>
          <span class="field-tag">Obligatorio</span>
        </div>

        <select
          id="modalidad"
          name="modalidad"
          required
          [(ngModel)]="selectedModalidad"
          #modalidadCtrl="ngModel"
          (change)="onModalidadChange()"
        >
          <option value="" disabled [selected]="!selectedModalidad">
            Selecciona modalidad
          </option>
          <option *ngFor="let m of modalidades" [value]="m.value">
            {{ m.label }}
          </option>
        </select>

        <p class="field-error" *ngIf="modalidadCtrl.invalid && modalidadCtrl.touched">
          La modalidad es obligatoria.
        </p>
      </div>

      <!-- Nivel (OBLIGATORIO) -->
      <div
        class="field"
        [class.has-error]="nivelCtrl.invalid && nivelCtrl.touched"
      >
        <div class="field-label-row">
          <label for="nivel">
            Nivel <span class="required">*</span>
          </label>
          <span class="field-tag">Obligatorio</span>
        </div>

        <select
          id="nivel"
          name="nivel"
          required
          [(ngModel)]="selectedNivel"
          #nivelCtrl="ngModel"
          (ngModelChange)="onNivelChange()"
          [disabled]="!niveles.length"
        >
          <option value="" disabled [selected]="!selectedNivel">
            Selecciona nivel
          </option>
          <option *ngFor="let n of niveles" [value]="n.codNivel">
            {{ n.nombre }}
          </option>
        </select>

        <p class="field-error" *ngIf="nivelCtrl.invalid && nivelCtrl.touched">
          El nivel es obligatorio.
        </p>
      </div>
    </div>
  </div>

  <!-- Nombre del colegio (OPCIONAL) -->
  <div class="field field-full">
    <div class="field-label-row">
      <label for="gestion">
        Nombre del colegio
      </label>
      <span class="field-tag optional">Opcional</span>
    </div>

    <input
      id="gestion"
      type="search"
      name="gestion"
      [(ngModel)]="searchTerm"
      (keyup.enter)="buscar()"
      placeholder="Escribe el nombre del colegio (opcional)..."
      aria-label="Buscar colegio por nombre"
    />

    <p class="field-help">
      Puedes buscar solo por ubicaci√≥n o combinarla con el nombre del colegio.
    </p>
  </div>

  <!-- Acciones -->
  <div class="actions">
    <button
      class="btn primary"
      type="button"
      (click)="buscar()"
      [disabled]="
        !selectedDepto ||
        !selectedProv  ||
        !selectedDist  ||
        !selectedModalidad ||
        !selectedNivel
      "
    >
      Buscar colegios
    </button>

    <button
      class="btn ghost"
      type="button"
      (click)="limpiar()"
    >
      Limpiar filtros
    </button>

    <button
      class="btn link"
      type="button"
      (click)="page = 0; buscar()"
      [disabled]="!colegios.length && !totalColegios"
    >
      Volver a la primera p√°gina
    </button>
  </div>
</section>


  <!-- ======================= Mensajes ======================= -->
  <section class="messages" aria-live="polite">
    <p class="info" *ngIf="mensaje">{{ mensaje }}</p>
    <p class="error" *ngIf="error">{{ error }}</p>
  </section>

  <!-- ======================= Resultados ======================= -->
  <div class="results-section card">
    <div class="results-header">
      <div>
        <h2>Resultados</h2>
        <p class="results-subtitle" *ngIf="colegios.length">
          Lista de colegios seg√∫n tus filtros.
        </p>
      </div>

      <!-- üîç Buscador local (solo aparece si hay resultados) -->
      <div class="results-tools" *ngIf="colegios.length">
        <div class="search-inline">
          <input type="search" [(ngModel)]="searchTerm" placeholder="Filtrar por nombre, distrito, gesti√≥n..."
            aria-label="Filtrar colegios por texto" />
          <button type="button" class="btn ghost small" *ngIf="searchTerm" (click)="limpiarBusquedaLocal()">
            ‚úï
          </button>
        </div>
      </div>
    </div>

    <div class="messages">
      <p class="info" *ngIf="mensaje">{{ mensaje }}</p>
      <p class="error" *ngIf="error">{{ error }}</p>

      <!-- Mensaje cuando hay filtro de texto aplicado -->
      <p class="info" *ngIf="searchTerm && filteredColegios.length !== colegios.length && filteredColegios.length">
        Filtrado por "<strong>{{ searchTerm }}</strong>": se muestran
        {{ filteredColegios.length }} colegios en esta p√°gina.
      </p>

      <p class="error" *ngIf="searchTerm && !filteredColegios.length && colegios.length">
        No hay coincidencias con "<strong>{{ searchTerm }}</strong>" en esta
        p√°gina. Borra el filtro o prueba con otra palabra.
      </p>
    </div>

    <div *ngIf="filteredColegios.length; else empty">
      <div class="results-grid">
        <!-- üëá aqu√≠ usamos filteredColegios en lugar de colegios -->
        <article class="school-card" *ngFor="let c of filteredColegios">
          <header class="school-header">
            <h3>{{ c.nombre }}</h3>
            <span class="pill">{{ c.gestion || 'Gesti√≥n no registrada' }}</span>
          </header>

          <p class="school-address">
            {{ c.direccion || 'Direcci√≥n no disponible' }}
          </p>

          <p class="school-ubigeo">
            {{ c.departamento }}, {{ c.provincia }}, {{ c.distrito }}
          </p>

          <dl class="school-meta">
            <div>
              <dt>Nivel</dt>
              <dd>{{ c.nivel || '‚Äî' }}</dd>
            </div>
            <div>
              <dt>Modalidad</dt>
              <dd>{{ c.modalidad || '‚Äî' }}</dd>
            </div>
            <div>
              <dt>Turno</dt>
              <dd>{{ c.turno || '‚Äî' }}</dd>
            </div>
            <div>
              <dt>Alumnado</dt>
              <dd>{{ c.alumnado || 'Mixto' }}</dd>
            </div>
            <div>
              <dt>Pensi√≥n aprox.</dt>
              <dd>
                <!-- si tienes la pensi√≥n en S/ -->
                <ng-container *ngIf="c.pension !== undefined && c.pension !== null && c.pension > 0; else sinPension">
                  S/ {{ c.pension }}
                </ng-container>
                <ng-template #sinPension>Sin informaci√≥n</ng-template>
              </dd>
            </div>
            <div>
              <dt>Est. por aula</dt>
              <dd>{{ c.estudiantesPorAula || '‚Äî' }}</dd>
            </div>
          </dl>

          <footer class="school-footer">
            <a class="btn link"
              [href]="'https://identicole.minedu.gob.pe/colegio/mi_colegio/' + (c.codModular || '') + '0'"
              target="_blank" rel="noopener noreferrer">
              Ver m√°s en Identicole ‚Üí
            </a>
          </footer>
        </article>
      </div>

      <!-- paginaci√≥n igual que antes -->
      <nav class="pagination" *ngIf="totalPages > 1">
        <button type="button" class="page-btn" (click)="paginaAnterior()" [disabled]="page === 0">
          ‚Äπ
        </button>

        <button type="button" class="page-btn" *ngFor="let p of [].constructor(totalPages); let i = index"
          [class.active]="i === page" (click)="irAPagina(i)">
          {{ i + 1 }}
        </button>

        <button type="button" class="page-btn" (click)="paginaSiguiente()" [disabled]="page + 1 >= totalPages">
          ‚Ä∫
        </button>
      </nav>
    </div>

    <ng-template #empty>
      <p class="empty-state">
        A√∫n no hay colegios para mostrar. Elige un departamento, provincia y
        distrito, luego haz clic en <strong>Buscar</strong>.
      </p>
    </ng-template>
  </div>
  <footer class="app-footer" aria-label="Aviso legal">
    <p class="disclaimer">
      Este es un proyecto personal no oficial, de car√°cter educativo y exploratorio.
      No est√° afiliado, patrocinado ni aprobado por el Ministerio de Educaci√≥n del Per√∫
      ni por la plataforma Identicole. La informaci√≥n mostrada proviene de servicios
      p√∫blicos del Estado peruano y puede no estar actualizada o completa.
    </p>
  </footer>

</div>